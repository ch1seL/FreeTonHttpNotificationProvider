@page "/test-consumer/{UserId}"
@inject NavigationManager _navigation
@inject IMessageInfoStorage _storage
@implements IAsyncDisposable

<ConsumerConnectionStatus IsConnected="@IsConnected"/>
<MessageInfoTable MessageInfos="@_messages" OnClearClickCallback="@OnClear"/>

@code {

    [ParameterAttribute]
    public string UserId { get; set; }

    private HubConnection _hubConnection;
    private IReadOnlyCollection<MessageInfo> _messages = Array.Empty<MessageInfo>();
    private bool IsConnected => _hubConnection.State == HubConnectionState.Connected;

    protected override async Task OnInitializedAsync()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(_navigation.ToAbsoluteUri($"/signalr?UserId={UserId}"))
            .WithAutomaticReconnect(Enumerable.Range(0, 20).Select(r => TimeSpan.FromSeconds(r * 2)).ToArray())
            .Build();
        _hubConnection.On<string>("ReceiveMessage", async message =>
        {
            _messages = await _storage.Push(new MessageInfo { DateTime = DateTime.Now, Message = message });
            StateHasChanged();
        });
        _hubConnection.Reconnecting += _ => InvokeAsync(StateHasChanged);
        _hubConnection.Closed += _ => InvokeAsync(StateHasChanged);
        _hubConnection.Reconnected += _ => InvokeAsync(StateHasChanged);
        await _storage.Init();
        _messages = await _storage.GetAll();
        await _hubConnection.StartAsync();
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }

    private async Task OnClear()
    {
        await _storage.Clear();
        _messages = await _storage.GetAll();
    }

}